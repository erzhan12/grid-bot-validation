# 0007 — Phase H: Testing & Validation

## Context

Phases B–G are complete. The project has ~854 tests across 7 packages with overall ~79% coverage. However, several critical modules have dangerously low coverage (REST client 16%, EventSaver main 18%, Gridbot main 0%, collectors 26–29%), and there are no cross-package integration tests or shadow-mode validation pipelines. All new tests will be fully mocked (no Bybit testnet dependency).

Phase H fills coverage gaps, adds integration tests for multi-component workflows, and builds a shadow-mode validation pipeline that runs gridbot + backtest on the same data and compares via the comparator.

---

## Part 1: Critical Coverage Gaps

### 1.1 BybitRestClient Tests (16% → 80%+)

**File to test**: `packages/bybit_adapter/src/bybit_adapter/rest_client.py`
**New test file**: `packages/bybit_adapter/tests/test_rest_client.py`

Methods to cover with mocked HTTP responses (`unittest.mock.patch` on `pybit.unified_trading.HTTP`):

- `get_order_history(symbol, ...)` — returns list of historical order dicts
- `get_wallet_balance(...)` — returns wallet balance dict
- `get_open_orders(symbol, ...)` — returns list of open order dicts
- `get_recent_trades(symbol, limit)` — returns list of trade dicts
- `get_executions(symbol, start_time, end_time, cursor)` — returns `(list, next_cursor)` tuple
- `get_executions_all(symbol, start_time, end_time)` — pagination loop (max 10 pages), verify it follows `next_cursor` until empty
- `get_positions(symbol)` — returns position list
- `place_order(symbol, side, price, qty, ...)` — returns order response
- `cancel_order(symbol, order_id)` — returns cancel response
- `cancel_all_orders(symbol)` — cancels all open orders for symbol

*Note: Method list updated post-implementation to reflect actual scope tested.*

Edge cases:
- API error responses (retCode != 0)
- Empty result sets
- Pagination with exactly 10 pages (max limit)
- Invalid symbol handling

### 1.2 EventSaver Orchestration Tests (18% → 70%+)

**File to test**: `apps/event_saver/src/event_saver/main.py`
**New test file**: `apps/event_saver/tests/test_main.py`

Test scenarios (mock all WebSocket clients and DB):

- `EventSaver.__init__()` — initializes components correctly
- `add_account()` — creates private collector, wires callbacks, warns if no `run_id`
- `start()` — stores event loop reference, starts public collector, connects WS
- `stop()` — disconnects all WS, flushes writers
- `_handle_trades()` — routes trades to writer (verify `run_coroutine_threadsafe` pattern)
- `_handle_ticker()` — routes ticker events
- `_handle_execution()` — routes to execution writer with run_id filtering
- `_handle_order()` — routes to order writer
- `_handle_position()` / `_handle_wallet()` — routes to respective writers

### 1.3 Event Collector Tests (26–29% → 70%+)

**Files to test**:
- `apps/event_saver/src/event_saver/collectors/public_collector.py`
- `apps/event_saver/src/event_saver/collectors/private_collector.py`

**New test files**:
- `apps/event_saver/tests/test_public_collector.py`
- `apps/event_saver/tests/test_private_collector.py`

Test scenarios:

- `PublicCollector.__init__()` — symbols list stored, callbacks wired
- `subscribe()` — calls WS subscribe with correct topics per symbol
- `_on_message()` — routes by topic type (ticker vs publicTrade), filters by symbol
- `PrivateCollector.__init__()` — account context stored
- `subscribe()` — subscribes to execution, order, position, wallet topics
- `_on_message()` — routes by topic, filters by `execType=="Trade"` and `orderType=="Limit"`
- Symbol filtering — events for non-subscribed symbols are dropped

### 1.4 Gridbot Main Entry Tests (0% → 60%+)

**File to test**: `apps/gridbot/src/gridbot/main.py`
**New test file**: `apps/gridbot/tests/test_main.py`

Test scenarios (mock Orchestrator, config loading):

- `parse_args()` — `--config`, `--debug` flags parsed correctly
- `load_config()` — valid YAML parsed into `GridbotConfig`
- `load_config()` — missing file raises SystemExit
- `load_config()` — invalid YAML raises SystemExit
- `main()` — creates Orchestrator, calls `start()`, registers signal handlers
- Signal handling — SIGINT/SIGTERM triggers `stop()`

### 1.5 WebSocket Client Edge Cases (78% → 85%+)

**File to test**: `packages/bybit_adapter/src/bybit_adapter/ws_client.py`
**Existing test file**: `packages/bybit_adapter/tests/test_ws_client.py`

Additional test scenarios:

- Heartbeat watchdog: fires disconnect callback after timeout
- Heartbeat watchdog: thread-safe `disconnect_ts` initialization
- `disconnect()` → `_stop_heartbeat_watchdog()` ordering (deadlock prevention)
- Reconnect: `connect()` after `disconnect()` re-subscribes channels
- `is_connected()` and `get_connection_state()` return correct values in each state

---

## Part 2: Cross-Package Integration Tests

### 2.1 New Integration Test Location

**New directory**: `tests/integration/`
**New conftest**: `tests/integration/conftest.py`

Shared fixtures:
- `db` — in-memory SQLite `DatabaseFactory` with tables created
- `sample_user`, `sample_account`, `sample_strategy`, `sample_run` — seeded DB entities
- `mock_ws_public`, `mock_ws_private` — mock WebSocket clients
- `grid_config` — standard `GridConfig` for tests
- `ticker_event_factory(price)` — creates `TickerEvent` at given price
- `execution_event_factory(...)` — creates `ExecutionEvent`

### 2.2 GridEngine → Executor Integration

**New test file**: `tests/integration/test_engine_to_executor.py`

Validates the full intent pipeline: `TickerEvent → GridEngine.on_event() → PlaceLimitIntent → IntentExecutor.execute_place()` (mocked Bybit API).

Test scenarios:
- First ticker builds grid and produces PlaceLimitIntents
- Intents have valid `client_order_id` (16-char hex)
- Executor correctly formats Bybit REST request from intent fields
- Cancel intents produce valid cancel requests
- `reduce_only` flag passed correctly

### 2.3 Backtest → Comparator Integration

**New test file**: `tests/integration/test_backtest_to_comparator.py`

Validates the backtest-comparator pipeline: run a small backtest, export trades CSV, load into comparator, compute metrics.

Test scenarios:
- Backtest produces trades CSV via `BacktestReporter.export_trades()`
- `BacktestTradeLoader.load_from_csv()` parses the exported CSV correctly
- `TradeMatcher.match()` produces expected matched/unmatched sets
- `calculate_metrics()` returns valid `ValidationMetrics`
- Round-trip: backtest vs itself should produce 100% match rate, zero deltas

### 2.4 EventSaver → Database Integration

**New test file**: `tests/integration/test_eventsaver_db.py`

Validates that normalized events flow correctly through writers into the database.

Test scenarios:
- `TradeWriter.add()` + `flush()` → trades queryable via `PublicTradeRepository`
- `ExecutionWriter.add()` + `flush()` → executions queryable via `PrivateExecutionRepository`
- `OrderWriter.add()` + `flush()` → orders queryable via repository
- Duplicate trade handling: second insert of same `trade_id` is silently skipped (ON CONFLICT DO NOTHING)
- Batch insert: 100+ trades in single flush, verify count matches

### 2.5 StrategyRunner Full Lifecycle

**New test file**: `tests/integration/test_runner_lifecycle.py`

Validates the full runner lifecycle: startup reconciliation → ticker → grid build → fills → position update → same-order detection.

Test scenarios:
- Startup: `inject_open_orders()` correctly adopts exchange orders
- First ticker: grid builds, intents generated
- Fill: execution event updates internal state, tracked order marked filled
- Position update: risk multipliers recalculated
- Same-order detection: two fills at same price blocks further execution
- Same-order recovery: new fill at different price clears error

---

## Part 3: Shadow-Mode Validation Pipeline

### 3.1 Overview

A test harness that simulates shadow-mode validation end-to-end:

1. Seed database with synthetic market data (public trades, ticker snapshots)
2. Run backtest on the seeded data → produces backtest trades
3. Simulate "live" trades from the same seeded data (using GridEngine directly with the same config)
4. Run comparator to compare backtest vs simulated-live results
5. Assert: match rate == 100%, price deltas == 0, PnL deltas == 0

This validates that gridcore produces identical results whether driven by the backtest engine or by a simulated live event loop — confirming the core extraction (Phase B) holds under the full pipeline.

### 3.2 Implementation

**New test file**: `tests/integration/test_shadow_validation.py`

Algorithm:
1. Create synthetic price series (e.g., 1000 ticks of BTCUSDT oscillating between 99000–101000)
2. Create `GridConfig` with known parameters (grid_step=0.2, grid_count=50)
3. **Backtest path**: Feed prices through `BacktestEngine` → collect fills from `BacktestSession`
4. **Live-simulation path**: Feed same prices through `GridEngine.on_event()` + `BacktestOrderManager` (simulating what gridbot would do)
5. Normalize both trade sets into `NormalizedTrade` format
6. Run `TradeMatcher.match()` → assert all trades matched
7. Run `calculate_metrics()` → assert match_rate == 1.0, all deltas == 0

### 3.3 Fixtures

**Shared fixtures in**: `tests/integration/conftest.py`

- `synthetic_price_series(symbol, start_price, amplitude, ticks)` — generates oscillating price data
- `standard_grid_config()` — returns `GridConfig(grid_step=0.2, grid_count=50)`
- `backtest_config(symbol, prices)` — returns `BacktestConfig` using `InMemoryDataProvider`

---

## Part 4: Test Infrastructure

### 4.1 Root conftest for Integration Tests

**New file**: `tests/integration/conftest.py`

- Imports from `gridcore`, `grid_db`, `backtest`, `comparator`
- Uses in-memory SQLite for all DB-backed tests
- Provides mock factories for WebSocket messages and API responses

### 4.2 Makefile Updates

**File to modify**: `Makefile`

Add new target:
- `make test-integration` — runs `uv run pytest tests/integration/ -v`
- Update `make test` to also include integration tests as a final step

### 4.3 Root pyproject.toml

**File to modify**: `pyproject.toml`

Add `tests/integration/` to test paths if needed. Ensure all workspace packages are available as dev dependencies.

---

## Files Summary

### New Files
| File | Purpose |
|------|---------|
| `packages/bybit_adapter/tests/test_rest_client.py` | REST client unit tests |
| `apps/event_saver/tests/test_main.py` | EventSaver orchestration tests |
| `apps/event_saver/tests/test_public_collector.py` | Public collector tests |
| `apps/event_saver/tests/test_private_collector.py` | Private collector tests |
| `apps/gridbot/tests/test_main.py` | Gridbot main entry tests |
| `tests/integration/conftest.py` | Shared integration fixtures |
| `tests/integration/test_engine_to_executor.py` | GridEngine → Executor pipeline |
| `tests/integration/test_backtest_to_comparator.py` | Backtest → Comparator pipeline |
| `tests/integration/test_eventsaver_db.py` | EventSaver → Database pipeline |
| `tests/integration/test_runner_lifecycle.py` | StrategyRunner full lifecycle |
| `tests/integration/test_shadow_validation.py` | Shadow-mode validation pipeline |

### Modified Files
| File | Change |
|------|--------|
| `packages/bybit_adapter/tests/test_ws_client.py` | Add heartbeat/reconnect edge cases |
| `Makefile` | Add `test-integration` target |
| `pyproject.toml` | Add integration test path if needed |
