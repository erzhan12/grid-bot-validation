# 0006 - Phase G: Comparator (Backtest vs Live Validation)

Validate the gridcore backtest engine by comparing its simulated results against real live trade data captured by event_saver. The comparator reads live `PrivateExecution` records from the database and backtest `BacktestTrade` records from a completed session, then produces trade-level, aggregate, and equity-curve validation reports.

## Data Sources

**Live (ground truth)**: `PrivateExecution` rows from `grid_db`, scoped by `run_id` + time range. Key fields: `exec_price`, `exec_qty`, `exec_fee`, `closed_pnl`, `side`, `order_link_id`, `exchange_ts`, `symbol`.

**Backtest**: `BacktestTrade` list from `BacktestSession`. Key fields: `price`, `qty`, `commission`, `realized_pnl`, `side`, `client_order_id`, `timestamp`, `symbol`, `direction`.

**Matching key**: `order_link_id` (live) == `client_order_id` (backtest) — both use the deterministic SHA256 hash from `PlaceLimitIntent.create()`.

## Package Structure

```
apps/comparator/
├── pyproject.toml              # Dependencies: grid-db, backtest (workspace)
├── src/comparator/
│   ├── __init__.py
│   ├── config.py               # ComparatorConfig (Pydantic)
│   ├── loader.py               # LiveTradeLoader, BacktestTradeLoader
│   ├── matcher.py              # TradeMatcher (join on client_order_id)
│   ├── metrics.py              # ValidationMetrics calculations
│   ├── reporter.py             # CSV + console report output
│   └── main.py                 # CLI entry point
└── tests/
    └── test_*.py
```

## Core Algorithm

### 1. Loading

**LiveTradeLoader** — queries `PrivateExecutionRepository.get_by_run_range(run_id, start, end)` and converts to a common `NormalizedTrade` dataclass:

```
@dataclass
class NormalizedTrade:
    client_order_id: str    # matching key
    symbol: str
    side: str               # 'Buy' / 'Sell'
    price: Decimal
    qty: Decimal
    fee: Decimal
    realized_pnl: Decimal   # closed_pnl for live, realized_pnl for backtest
    timestamp: datetime
    source: str             # 'live' or 'backtest'
```

- Live `PrivateExecution` may have multiple rows per `order_link_id` (partial fills). **Aggregate** partials into one trade per `order_link_id`: sum `exec_qty`, sum `exec_fee`, VWAP `exec_price`, sum `closed_pnl`, take latest `exchange_ts`.
- Skip rows where `order_link_id` is null (manual/non-grid orders).

**BacktestTradeLoader** — takes `BacktestSession.trades` list and converts to `NormalizedTrade`. Direct 1:1 mapping, no aggregation needed.

### 2. Matching

**TradeMatcher** joins live and backtest trades on `client_order_id`:

- **Matched pairs**: same `client_order_id` exists in both sources → `MatchedTrade(live, backtest)`
- **Live-only**: `client_order_id` in live but not backtest → trade happened on exchange but backtest didn't simulate it (missed fill)
- **Backtest-only**: `client_order_id` in backtest but not live → backtest simulated a fill that never happened on exchange (phantom fill)

Output: `MatchResult` with three lists: `matched`, `live_only`, `backtest_only`.

### 3. Validation Metrics

From matched pairs, compute per-trade deltas and aggregate metrics:

**Per-trade deltas** (for each matched pair):
- `price_delta = backtest.price - live.price` (fill price difference)
- `qty_delta = backtest.qty - live.qty` (quantity difference)
- `fee_delta = backtest.fee - live.fee` (commission difference)
- `pnl_delta = backtest.realized_pnl - live.realized_pnl` (PnL difference)

**Aggregate metrics** (`ValidationMetrics` dataclass):
- `total_live_trades`: count of live trades in range
- `total_backtest_trades`: count of backtest trades
- `matched_count`: trades found in both
- `live_only_count`: trades only in live (missed by backtest)
- `backtest_only_count`: trades only in backtest (phantom fills)
- `match_rate`: `matched_count / total_live_trades` (how many live trades backtest predicted)
- `phantom_rate`: `backtest_only_count / total_backtest_trades`
- **Price accuracy**: mean/median/max absolute `price_delta` across matched pairs
- **Qty accuracy**: mean/median/max absolute `qty_delta`
- **Fee accuracy**: total `fee_delta` (backtest commission vs live fees)
- **PnL accuracy**: `cumulative_pnl_delta` (sum of all pnl_delta), `pnl_correlation` (Pearson correlation of cumulative PnL curves)
- **Volume comparison**: total live volume vs total backtest volume
- **Direction breakdown**: long match rate, short match rate, long PnL delta, short PnL delta
- **Timing**: mean timestamp delta between matched trades (how close backtest fill time is to live)

### 4. Equity Curve Comparison

Reconstruct a live equity curve from `WalletSnapshot` records (query `WalletSnapshotRepository`) and compare against `BacktestSession.equity_curve`:
- Resample both curves to common time grid (e.g., 1-hour buckets)
- Compute: max equity divergence, mean divergence, correlation
- Export both curves side-by-side for plotting

### 5. Reporting

**Console summary**: Print key metrics (match rate, PnL delta, price accuracy) to stdout.

**CSV exports** (`ComparatorReporter`):
- `matched_trades.csv`: side-by-side live vs backtest per matched pair with deltas
- `unmatched_trades.csv`: live-only and backtest-only trades
- `validation_metrics.csv`: key-value aggregate metrics
- `equity_comparison.csv`: resampled equity curves side-by-side

## CLI Interface

```bash
# Compare a live run against a backtest session
uv run python -m comparator.main \
    --run-id "uuid-of-live-run" \
    --backtest-config conf/backtest.yaml \
    --start "2025-01-01" --end "2025-01-31" \
    --output results/comparison/

# Using existing backtest CSV export instead of re-running
uv run python -m comparator.main \
    --run-id "uuid-of-live-run" \
    --backtest-trades path/to/trades.csv \
    --output results/comparison/
```

`ComparatorConfig` fields:
- `run_id`: Live run ID to compare against
- `database_url`: Database connection (reuse `GRIDBOT_DB_*` env vars)
- `start_ts`, `end_ts`: Time window
- `symbol`: Symbol filter (optional in CSV mode; **required** when using `--backtest-config`)
- `output_dir`: Where to write CSV reports
- `price_tolerance`: Acceptable price delta before flagging (default: 0, exact match expected for limit orders)
- `qty_tolerance`: Acceptable qty delta (default: `Decimal("0.001")`)

## Files to Create

| File | Purpose |
|------|---------|
| `apps/comparator/pyproject.toml` | Package config with grid-db, backtest deps |
| `apps/comparator/src/comparator/__init__.py` | Package exports |
| `apps/comparator/src/comparator/config.py` | `ComparatorConfig` Pydantic model |
| `apps/comparator/src/comparator/loader.py` | `NormalizedTrade`, `LiveTradeLoader`, `BacktestTradeLoader` |
| `apps/comparator/src/comparator/matcher.py` | `TradeMatcher`, `MatchedTrade`, `MatchResult` |
| `apps/comparator/src/comparator/metrics.py` | `ValidationMetrics`, metric calculation functions |
| `apps/comparator/src/comparator/reporter.py` | `ComparatorReporter` (CSV + console output) |
| `apps/comparator/src/comparator/main.py` | CLI with argparse |
| `apps/comparator/tests/conftest.py` | Fixtures (in-memory DB, sample data) |
| `apps/comparator/tests/test_loader.py` | Loader tests |
| `apps/comparator/tests/test_matcher.py` | Matcher tests |
| `apps/comparator/tests/test_metrics.py` | Metrics calculation tests |
| `apps/comparator/tests/test_reporter.py` | Reporter output tests |

## Existing Files to Modify

| File | Change |
|------|--------|
| `pyproject.toml` (root) | Add `comparator` to workspace members |
| `Makefile` | Add `comparator` test target to `make test` |
| `RULES.md` | Add Phase G section after implementation |

## Key Design Decisions

1. **No bbu2 reference needed** — comparison is purely gridcore backtest vs live exchange data
2. **`client_order_id` is the join key** — deterministic SHA256 hash is identical in both live (via gridbot) and backtest
3. **Partial fill aggregation** — live data may have multiple executions per order; aggregate before comparing
4. **Price should match exactly** — both live and backtest use limit orders at the same price; any price delta indicates a bug
5. **Qty may differ slightly** — backtest qty depends on simulated wallet balance which diverges from live over time; tolerance needed
6. **PnL divergence is expected** — cumulative PnL will drift as qty differences compound; the key metric is correlation, not exact match
7. **Equity comparison is approximate** — live wallet includes non-grid activity; filter by run_id but note potential noise
