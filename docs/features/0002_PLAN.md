# Phase C: Multi-Tenant Database Layer

## Overview

Implement a multi-tenant database layer supporting 10-20 Bybit accounts with user isolation, strategy configuration, and run tracking. The database module will use SQLAlchemy ORM to support both SQLite (development) and PostgreSQL (production) with a single codebase.

**Key Constraints**:
- SQLite for development, PostgreSQL for production
- API keys stored as plaintext initially (encryption deferred)
- Repository pattern with multi-tenant filtering (all queries scoped by user_id)
- Zero breaking changes to existing gridcore package

---

## 1. Package Structure

Create the following structure in `shared/db/`:

```
shared/
└── db/
    ├── __init__.py           # Package exports
    ├── settings.py           # Pydantic database configuration
    ├── models.py             # SQLAlchemy ORM models (7 tables)
    ├── database.py           # Database connection factory
    ├── repositories.py       # CRUD operations with multi-tenant filtering
    ├── init_db.py            # Database initialization script
    ├── pyproject.toml        # Package dependencies
    └── tests/
        ├── __init__.py
        ├── conftest.py       # Test fixtures
        ├── test_models.py
        ├── test_database.py
        └── test_repositories.py
```

---

## 2. Settings Module (`settings.py`)

Define database configuration using Pydantic settings.

### 2.1 Configuration Fields

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `database_url` | Optional[str] | None | Direct connection URL (overrides other fields) |
| `db_type` | str | "sqlite" | "sqlite" or "postgresql" |
| `db_host` | Optional[str] | None | PostgreSQL host |
| `db_port` | Optional[str] | None | PostgreSQL port |
| `db_user` | Optional[str] | None | PostgreSQL user |
| `db_password` | Optional[str] | None | PostgreSQL password |
| `db_name` | str | "grid_bot.db" | Database name or SQLite file path |
| `pool_size` | int | 5 | PostgreSQL connection pool size |
| `echo_sql` | bool | False | Log SQL statements (debug) |

### 2.2 URL Generation

`get_database_url()` method builds connection string:
- SQLite: `sqlite+pysqlite:///grid_bot.db`
- PostgreSQL: `postgresql+psycopg2://user:pass@host:port/dbname`

### 2.3 Environment Variables

Prefix: `GRIDBOT_DB_` (e.g., `GRIDBOT_DB_TYPE`, `GRIDBOT_DB_HOST`)

**Reference Pattern**: `bbu_reference/backtest_reference/bbu_backtest-main/config/settings.py` for Pydantic settings structure.

---

## 3. Models Module (`models.py`)

Define SQLAlchemy ORM models for all 7 tables from engineering plan Section 2.

### 3.1 Core Entity Tables

#### Users Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| user_id | String(36) | PRIMARY KEY, default UUID | Unique user identifier |
| username | String(100) | UNIQUE, NOT NULL | Login username |
| email | String(255) | UNIQUE | Contact email |
| status | String(20) | default "active" | "active", "suspended", "deleted" |
| created_at | DateTime(tz) | default NOW | Account creation timestamp |
| updated_at | DateTime(tz) | default NOW, onupdate NOW | Last modification timestamp |

**Relationships**: One-to-many → `bybit_accounts`, `runs`

#### BybitAccounts Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| account_id | String(36) | PRIMARY KEY, default UUID | Unique account identifier |
| user_id | String(36) | FK → users.user_id, CASCADE | Owner user |
| account_name | String(100) | NOT NULL | Account label |
| environment | String(10) | NOT NULL | "mainnet" or "testnet" |
| status | String(20) | default "enabled" | "enabled", "disabled", "error" |
| created_at | DateTime(tz) | default NOW | Creation timestamp |

**Constraints**: UNIQUE(user_id, account_name)
**Relationships**: Many-to-one → `users`, One-to-many → `api_credentials`, `strategies`, `runs`

#### ApiCredentials Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| credential_id | String(36) | PRIMARY KEY, default UUID | Unique credential identifier |
| account_id | String(36) | FK → bybit_accounts.account_id, CASCADE | Parent account |
| api_key_id | String(100) | NOT NULL | Bybit API key (public) |
| api_secret | Text | NOT NULL | API secret (plaintext for now) |
| is_active | Boolean | default True | Currently active credential |
| created_at | DateTime(tz) | default NOW | Creation timestamp |
| rotated_at | DateTime(tz) | nullable | Last rotation timestamp |

**Relationships**: Many-to-one → `bybit_accounts`

#### Strategies Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| strategy_id | String(36) | PRIMARY KEY, default UUID | Unique strategy identifier |
| account_id | String(36) | FK → bybit_accounts.account_id, CASCADE | Parent account |
| strategy_type | String(50) | NOT NULL | "GridStrategy" |
| symbol | String(20) | NOT NULL | Trading pair (e.g., "BTCUSDT") |
| config_json | JSON/JSONB | NOT NULL | GridConfig as JSON |
| is_enabled | Boolean | default True | Strategy active flag |
| created_at | DateTime(tz) | default NOW | Creation timestamp |

**Constraints**: UNIQUE(account_id, symbol)
**Relationships**: Many-to-one → `bybit_accounts`, One-to-many → `runs`

#### Runs Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| run_id | String(36) | PRIMARY KEY, default UUID | Unique run identifier |
| user_id | String(36) | FK → users.user_id | Run owner (for multi-tenant filtering) |
| account_id | String(36) | FK → bybit_accounts.account_id | Associated account |
| strategy_id | String(36) | FK → strategies.strategy_id | Associated strategy |
| run_type | String(20) | NOT NULL | "live", "backtest", "shadow" |
| gridcore_version | String(50) | nullable | Version string for reproducibility |
| config_snapshot | JSON/JSONB | nullable | GridConfig snapshot at run start |
| start_ts | DateTime(tz) | default NOW | Run start timestamp |
| end_ts | DateTime(tz) | nullable | Run end timestamp |
| status | String(20) | default "running" | "running", "completed", "failed" |

**Indexes**: user_id, account_id, status (for common queries)
**Relationships**: Many-to-one → `users`, `bybit_accounts`, `strategies`, One-to-many → `private_executions`

### 3.2 Data Tables (High Volume)

#### PublicTrades Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | BigInteger | PRIMARY KEY, autoincrement | Row identifier |
| symbol | String(20) | NOT NULL | Trading pair |
| trade_id | String(50) | NOT NULL | Exchange trade ID |
| exchange_ts | DateTime(tz) | NOT NULL | Exchange timestamp |
| local_ts | DateTime(tz) | NOT NULL | Local receive timestamp |
| side | String(4) | NOT NULL | "Buy" or "Sell" |
| price | Numeric(20,8) | NOT NULL | Trade price |
| size | Numeric(20,8) | NOT NULL | Trade size |

**Indexes**: (symbol, exchange_ts) for time-range queries

#### PrivateExecutions Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | BigInteger | PRIMARY KEY, autoincrement | Row identifier |
| run_id | String(36) | FK → runs.run_id | Parent run |
| account_id | String(36) | NOT NULL | Account identifier |
| symbol | String(20) | NOT NULL | Trading pair |
| exec_id | String(50) | NOT NULL | Exchange execution ID |
| order_id | String(50) | NOT NULL | Exchange order ID |
| order_link_id | String(50) | nullable | Client order ID (for matching) |
| exchange_ts | DateTime(tz) | NOT NULL | Execution timestamp |
| side | String(4) | NOT NULL | "Buy" or "Sell" |
| exec_price | Numeric(20,8) | NOT NULL | Execution price |
| exec_qty | Numeric(20,8) | NOT NULL | Execution quantity |
| exec_fee | Numeric(20,8) | nullable | Trading fee |
| closed_pnl | Numeric(20,8) | nullable | Realized P&L |
| raw_json | JSON/JSONB | nullable | Full exchange response |

**Indexes**: (account_id, exchange_ts), run_id

---

## 4. Database Module (`database.py`)

Database connection factory supporting SQLite and PostgreSQL.

### 4.1 DatabaseFactory Class

| Method | Description |
|--------|-------------|
| `__init__(settings)` | Initialize with DatabaseSettings |
| `engine` (property) | Lazy-load SQLAlchemy engine |
| `session_factory` (property) | Lazy-load sessionmaker |
| `create_tables()` | Create all tables via Base.metadata.create_all() |
| `drop_tables()` | Drop all tables (for testing) |
| `get_session()` | Context manager yielding Session |

### 4.2 SQLite-Specific Handling

- Use `StaticPool` for in-memory database
- Add `connect_args={"check_same_thread": False}`
- Listen for "connect" event to run `PRAGMA foreign_keys=ON`

### 4.3 PostgreSQL-Specific Handling

- Use `QueuePool` with configurable size
- Configure pool_timeout, pool_recycle for connection management

### 4.4 Session Context Manager

`get_session()` context manager:
1. Create session from factory
2. Yield session to caller
3. On success: commit
4. On exception: rollback
5. Finally: close session

**Reference Pattern**: `bbu_reference/backtest_reference/bbu_backtest-main/db/database.py` for SQLAlchemy session patterns.

---

## 5. Repositories Module (`repositories.py`)

Repository pattern for encapsulated CRUD operations with multi-tenant filtering.

### 5.1 BaseRepository[T] Generic Class

| Method | Parameters | Description |
|--------|------------|-------------|
| `get_by_id` | id: str | Get entity by primary key |
| `get_all` | limit, offset | Paginated list of all entities |
| `create` | entity: T | Insert new entity |
| `update` | entity: T | Merge existing entity |
| `delete` | entity: T | Remove entity |

### 5.2 UserRepository

| Method | Description |
|--------|-------------|
| `get_by_username` | Find user by username |
| `get_active_users` | Get users where status="active" |

### 5.3 BybitAccountRepository

| Method | Description |
|--------|-------------|
| `get_by_user_id` | All accounts for a user |
| `get_enabled_accounts` | Enabled accounts for a user |

### 5.4 StrategyRepository

| Method | Description |
|--------|-------------|
| `get_by_account_id` | All strategies for an account |
| `get_enabled_strategies` | Enabled strategies for an account |

### 5.5 RunRepository (Multi-Tenant Critical)

| Method | Description |
|--------|-------------|
| `get_by_user_id` | Runs filtered by user_id (access control) |
| `get_running` | Currently running runs for a user |

**Critical**: All Run queries MUST filter by user_id to enforce multi-tenant data isolation.

---

## 6. Init Script (`init_db.py`)

CLI utility for database initialization:
1. Load DatabaseSettings (from env or defaults)
2. Create DatabaseFactory instance
3. Call `create_tables()` to create schema
4. Print confirmation with database URL

Entry point for `python -m shared.db.init_db`

---

## 7. Package Configuration

### 7.1 `shared/db/pyproject.toml`

Dependencies:
- `sqlalchemy>=2.0` - ORM
- `pydantic-settings>=2.0` - Configuration
- `psycopg2-binary>=2.9` - PostgreSQL driver

Build system: hatchling

### 7.2 Root `pyproject.toml` Update

Add to workspace members: `shared/*`

---

## 8. Unit Tests

### 8.1 Test Fixtures (`conftest.py`)

| Fixture | Scope | Description |
|---------|-------|-------------|
| `db_settings` | function | In-memory SQLite settings |
| `db` | function | Fresh DatabaseFactory per test |
| `session` | function | Session from db.get_session() |
| `sample_user` | function | Created User entity |
| `sample_account` | function | Created BybitAccount for sample_user |

### 8.2 Model Tests (`test_models.py`)

| Test | Description |
|------|-------------|
| `test_user_creation` | User created with defaults (status, created_at) |
| `test_user_unique_username` | Duplicate username raises IntegrityError |
| `test_account_creation` | Account created with FK to user |
| `test_account_cascade_delete` | Deleting user cascades to accounts |
| `test_strategy_config_json` | JSON config stored and retrieved correctly |

### 8.3 Database Tests (`test_database.py`)

| Test | Description |
|------|-------------|
| `test_sqlite_connection` | Engine connects, executes "SELECT 1" |
| `test_create_tables` | Tables created in sqlite_master |
| `test_session_context_manager` | Commits on success |
| `test_session_rollback_on_error` | Rolls back on exception |

### 8.4 Repository Tests (`test_repositories.py`)

| Test | Description |
|------|-------------|
| `test_get_by_username` | UserRepository finds by username |
| `test_get_active_users` | Only returns status="active" users |
| `test_runs_filtered_by_user` | RunRepository enforces user_id isolation |

---

## 9. SQLite/PostgreSQL Compatibility Notes

| Feature | SQLite | PostgreSQL |
|---------|--------|------------|
| UUID | String(36) | String(36) (not native UUID for compatibility) |
| JSON | TEXT-based JSON | Native JSONB |
| Foreign Keys | Requires PRAGMA | Native support |
| Connection Pool | StaticPool | QueuePool |
| Partitioning | Not supported | Available (defer to Phase D) |

---

## 10. Files Summary

| New File | Purpose |
|----------|---------|
| `shared/db/__init__.py` | Package exports |
| `shared/db/settings.py` | DatabaseSettings class |
| `shared/db/models.py` | All 7 SQLAlchemy models |
| `shared/db/database.py` | DatabaseFactory class |
| `shared/db/repositories.py` | Repository classes |
| `shared/db/init_db.py` | CLI initialization script |
| `shared/db/pyproject.toml` | Package configuration |
| `shared/db/tests/__init__.py` | Test package |
| `shared/db/tests/conftest.py` | Test fixtures |
| `shared/db/tests/test_models.py` | Model tests |
| `shared/db/tests/test_database.py` | Database tests |
| `shared/db/tests/test_repositories.py` | Repository tests |

| Modified File | Change |
|---------------|--------|
| `pyproject.toml` (root) | Add `shared/*` to workspace members |
| `RULES.md` | Add Phase C implementation notes |

---

## 11. Done Criteria

1. All 7 tables created via `create_tables()` in both SQLite and PostgreSQL
2. Foreign key cascades work correctly (delete user → delete accounts)
3. JSON/JSONB config storage works for Strategy.config_json
4. Multi-tenant filtering: `RunRepository.get_by_user_id()` returns only user's runs
5. Session context manager commits on success, rolls back on exception
6. All unit tests pass with `pytest --cov=shared.db --cov-fail-under=80`
7. `uv sync` successfully installs shared/db package
