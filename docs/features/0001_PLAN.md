# Phase B: Core Library Extraction (gridcore)

## Overview

Extract pure strategy logic from `bbu2-master` into a shared `gridcore` package that has **zero exchange-specific dependencies**. The extracted code must produce identical results to the original while being usable by both live trading and backtesting applications.

**Key Constraint**: `gridcore` must have NO imports from `pybit`, `BybitApiUsdt`, or any exchange-specific code.

---

## 1. Package Structure

Create the following structure in `packages/gridcore/`:

```
packages/gridcore/
├── pyproject.toml
├── src/
│   └── gridcore/
│       ├── __init__.py
│       ├── events.py       # Normalized event models
│       ├── intents.py      # Order intent models
│       ├── grid.py         # Grid level calculations (from greed.py)
│       ├── engine.py       # GridEngine (from Strat50)
│       ├── position.py     # Position state tracking
│       └── config.py       # GridConfig dataclass
└── tests/
    ├── __init__.py
    ├── test_grid.py
    ├── test_engine.py
    └── test_events.py
```

---

## 2. Events Module (`events.py`)

Define normalized, immutable event models that strategy logic consumes.

### 2.1 Event Types to Define

| Event Class | Source | Key Fields |
|-------------|--------|------------|
| `TickerEvent` | `tickers.{symbol}` WS | `last_price`, `mark_price`, `bid1_price`, `ask1_price`, `funding_rate` |
| `PublicTradeEvent` | `publicTrade.{symbol}` WS | `trade_id`, `side`, `price`, `size` |
| `ExecutionEvent` | `execution` private WS | `exec_id`, `order_id`, `order_link_id`, `price`, `qty`, `fee`, `closed_pnl` |
| `OrderUpdateEvent` | `order` private WS | `order_id`, `status`, `price`, `qty`, `leaves_qty` |

### 2.2 Base Event Model

```python
@dataclass(frozen=True)
class Event:
    event_type: EventType  # Enum: TICKER, PUBLIC_TRADE, EXECUTION, ORDER_UPDATE
    symbol: str
    exchange_ts: datetime  # Primary sort key
    local_ts: datetime     # Tiebreaker for deterministic ordering
    # Multi-tenant tags (optional, for run tracking)
    user_id: Optional[UUID] = None
    account_id: Optional[UUID] = None
    run_id: Optional[UUID] = None
```

### 2.3 Specific Event Models

Each event type extends base with specific fields. All use `@dataclass(frozen=True)` for immutability.

**Reference**: Current ticker handling in `bbu2-master/bybit_api_usdt.py:94-99` stores `message['data']` - extract `lastPrice`, `markPrice`, `bid1Price`, `ask1Price`, `fundingRate`.

---

## 3. Intents Module (`intents.py`)

Define order intents that strategy emits (strategy does NOT call exchange APIs).

### 3.1 Intent Types

```python
@dataclass(frozen=True)
class PlaceLimitIntent:
    symbol: str
    side: str            # 'Buy' or 'Sell'
    price: Decimal
    qty: Decimal
    reduce_only: bool
    client_order_id: str  # Auto-generated UUID for matching
    grid_level: int       # Grid level index for comparison reports
    direction: str        # 'long' or 'short'

@dataclass(frozen=True)
class CancelIntent:
    symbol: str
    order_id: str
    reason: str          # 'side_mismatch', 'outside_grid', 'rebuild'
```

---

## 4. Grid Module (`grid.py`)

Extract from `bbu2-master/greed.py` with tick_size parameterization.

### 4.1 Key Transformation: Remove BybitApiUsdt Dependency

**Current code** (`greed.py:26,30,37,127,131`):
```python
price = BybitApiUsdt.round_price(self.symbol, price*(1+step))
```

**Target code**:
```python
price = self._round_price(price * (1 + step))

def _round_price(self, price: float) -> float:
    """Round price to tick_size precision"""
    rounded = round(price / self.tick_size) * self.tick_size
    return float(f'{rounded:.10f}')  # Avoid floating-point artifacts
```

### 4.2 Grid Class Signature Change

**Current** (`greed.py:7`):
```python
def __init__(self, strat, symbol, n=50, step=0.2):
```

**Target**:
```python
def __init__(self, tick_size: Decimal, greed_count: int = 50, greed_step: float = 0.2):
```

### 4.3 Functions to Extract

| Original Function | Location | Changes Required |
|-------------------|----------|------------------|
| `build_greed(last_close)` | `greed.py:18-41` | Replace `BybitApiUsdt.round_price` with internal `_round_price`; Remove `write_to_db()` call |
| `update_greed(last_filled_price, last_close)` | `greed.py:48-66` | Remove `write_to_db()` call; Keep `__center_greed()` call |
| `__center_greed()` | `greed.py:106-132` | Replace `BybitApiUsdt.round_price` with `_round_price` |
| `__is_too_close(price1, price2)` | `greed.py:134-135` | No changes (pure math) |
| Properties: `__min_greed`, `__max_greed`, `__greed_count_buy`, `__greed_count_sell` | `greed.py:143-167` | No changes (pure accessors) |

### 4.4 Remove These Methods (DB-specific)

- `read_from_db()` (`greed.py:137-138`)
- `write_to_db()` (`greed.py:140-141`)

### 4.5 Validation Functions to Add

Add validation methods currently commented out in `greed.py:68-104`:
- `is_price_sorted()` - Verify prices are in ascending order
- `is_greed_correct()` - Verify BUY→WAIT→SELL sequence

---

## 5. Engine Module (`engine.py`)

Extract core strategy logic from `bbu2-master/strat.py` Strat50 class.

### 5.1 Event-Driven Design Pattern

**Current flow** (`strat.py:79-99`):
```python
def _check_pair_step(self, symbol):
    # Makes network calls: get_same_orders_error, get_last_close, etc.
    self._check_and_place('long')
    self._check_and_place('short')
```

**Target flow**:
```python
def on_event(self, event: Event) -> list[Intent]:
    """Process event and return list of intents. PURE FUNCTION."""
    intents = []
    if isinstance(event, TickerEvent):
        self.last_close = event.last_price
        intents.extend(self._check_and_place('long'))
        intents.extend(self._check_and_place('short'))
    elif isinstance(event, ExecutionEvent):
        self.last_filled_price = event.price
        self.grid.update_greed(event.price, self.last_close)
    return intents
```

### 5.2 GridEngine Class Structure

```python
class GridEngine:
    """Pure strategy engine - NO network calls, NO side effects"""

    def __init__(self, config: GridConfig, tick_size: Decimal):
        self.config = config
        self.tick_size = tick_size
        self.grid = Grid(tick_size, config.greed_count, config.greed_step)
        self.last_close: Optional[float] = None
        self.last_filled_price: Optional[float] = None
        self.pending_orders: dict[str, PendingOrder] = {}  # client_order_id → order

    def on_event(self, event: Event) -> list[Intent]:
        """Process event and return list of intents. PURE FUNCTION."""
        pass
```

### 5.3 Functions to Extract from Strat50

| Original Function | Location | Transformation |
|-------------------|----------|----------------|
| `_check_and_place(direction)` | `strat.py:101-107` | Return `list[Intent]` instead of calling controller |
| `__place_greed_orders(i_limits, direction)` | `strat.py:124-160` | Return `list[PlaceLimitIntent | CancelIntent]` |
| `__place_order(greed, direction)` | `strat.py:162-182` | Return `PlaceLimitIntent` instead of calling controller |
| `_get_wait_indices()` | `strat.py:114-122` | No changes (pure computation) |

### 5.4 Remove Controller Dependencies

Current code calls `self.controller.*` methods:
- `controller.get_same_orders_error(self)` → Track internally via pending_orders state
- `controller.get_limit_orders(self, symbol, direction)` → Pass as parameter to `on_event`
- `controller.new_order(...)` → Return `PlaceLimitIntent` instead
- `controller.cancel_order(...)` → Return `CancelIntent` instead
- `controller.check_positions_ratio(...)` → Separate position management concern

---

## 6. Config Module (`config.py`)

```python
@dataclass(frozen=True)
class GridConfig:
    greed_count: int = 50          # Number of grid levels
    greed_step: float = 0.2        # Step size in percentage
    rebalance_threshold: float = 0.3  # From Greed.REBALANCE_THRESHOLD
```

---

## 7. Position Module (`position.py`)

Extract position state tracking without exchange dependencies.

### 7.1 Position State Dataclass

```python
@dataclass
class PositionState:
    direction: str  # 'long' or 'short'
    size: Decimal = Decimal('0')
    entry_price: Optional[Decimal] = None
    unrealized_pnl: Decimal = Decimal('0')
    margin: Decimal = Decimal('0')
    liquidation_price: Decimal = Decimal('0')
    leverage: int = 1
```

### 7.2 Amount Multiplier Logic

Extract from `bbu2-master/position.py:52-92` the `__calc_amount_multiplier` logic:
- Long position multiplier rules (`position.py:58-74`)
- Short position multiplier rules (`position.py:76-92`)
- Low margin adjustment (`position.py:37-50`)

**Note**: This is complex risk management logic. Keep it as a separate `PositionRiskManager` class that takes position state and returns multipliers.

---

## 8. Unit Tests

### 8.1 Grid Tests (`test_grid.py`)

| Test Case | Description | Validation |
|-----------|-------------|------------|
| `test_build_greed_basic` | Build grid with 50 levels, 0.2% step | Assert 51 items (25 buy + 1 wait + 25 sell) |
| `test_build_greed_price_rounding` | Verify tick_size rounding | Compare with `BybitApiUsdt.round_price` output for BTCUSDT (tick_size=0.1) |
| `test_update_greed_side_assignment` | After fill, sides update correctly | Check BUY/WAIT/SELL sequence preserved |
| `test_center_grid_buy_heavy` | More buys than sells, imbalance >30% | Grid shifts upward (top sell added, bottom buy removed) |
| `test_center_grid_sell_heavy` | More sells than buys, imbalance >30% | Grid shifts downward |
| `test_is_too_close` | Price within greed_step/4 | Returns True |
| `test_is_price_sorted` | All grid prices ascending | Returns True |
| `test_is_greed_correct` | Valid BUY→WAIT→SELL sequence | Returns True |

### 8.2 Engine Tests (`test_engine.py`)

| Test Case | Description |
|-----------|-------------|
| `test_on_ticker_event_builds_grid` | First ticker event initializes grid |
| `test_on_ticker_event_returns_place_intents` | Returns PlaceLimitIntent for each grid level |
| `test_on_execution_event_updates_last_filled` | ExecutionEvent updates last_filled_price |
| `test_place_order_eligibility` | Verify diff_p > greed_step/2 check |
| `test_cancel_intent_side_mismatch` | Wrong side order gets CancelIntent |
| `test_cancel_intent_outside_grid` | Price outside grid range gets CancelIntent |

### 8.3 Comparison Test (Critical)

```python
def test_grid_calculations_match_original():
    """Verify gridcore produces identical results to bbu2/greed.py"""
    # Setup original
    original_greed = Greed(mock_strat, 'BTCUSDT', n=50, step=0.2)
    BybitApiUsdt.ticksizes['BTCUSDT'] = 0.1
    original_greed.build_greed(100000.0)

    # Setup new
    new_grid = Grid(tick_size=Decimal('0.1'), greed_count=50, greed_step=0.2)
    new_grid.build_greed(100000.0)

    # Compare
    for orig, new in zip(original_greed.greed, new_grid.greed):
        assert orig['price'] == new['price'], f"Price mismatch: {orig['price']} vs {new['price']}"
        assert orig['side'] == new['side'], f"Side mismatch: {orig['side']} vs {new['side']}"
```

---

## 9. Dependencies

### 9.1 `pyproject.toml` for gridcore

```toml
[project]
name = "gridcore"
version = "0.1.0"
requires-python = ">=3.11"
dependencies = []  # NO EXTERNAL DEPENDENCIES

[project.optional-dependencies]
dev = ["pytest>=8.0", "pytest-cov"]
```

### 9.2 Zero Exchange Dependencies Validation

Add CI check:
```bash
# Fail if any exchange-specific imports found
grep -r "from pybit\|from bybit\|BybitApi" packages/gridcore/src/ && exit 1
```

---

## 10. Files Summary

| New File | Source | Lines (Est.) |
|----------|--------|--------------|
| `gridcore/events.py` | New | ~80 |
| `gridcore/intents.py` | New | ~40 |
| `gridcore/grid.py` | `bbu2/greed.py` | ~150 |
| `gridcore/engine.py` | `bbu2/strat.py` | ~200 |
| `gridcore/position.py` | `bbu2/position.py` (partial) | ~100 |
| `gridcore/config.py` | New | ~20 |
| `tests/test_grid.py` | New | ~200 |
| `tests/test_engine.py` | New | ~150 |
| `tests/test_events.py` | New | ~50 |

---

## 11. Done Criteria

1. `gridcore` package imports successfully with zero exchange-specific dependencies
2. `Grid.build_greed()` produces identical price/side lists as original `Greed.build_greed()`
3. `Grid.update_greed()` produces identical results as original
4. `Grid.center_grid()` produces identical results as original `__center_greed()`
5. All unit tests pass with `pytest --cov=gridcore --cov-fail-under=95`
6. CI validation confirms no `pybit` or `BybitApi` imports in gridcore
